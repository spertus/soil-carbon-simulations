---
title: "Simulating SOC Measurement"
author: "Jake Spertus"
date: "October 31st, 2019"
output: html_notebook
---

```{r knitr setup, message = FALSE, warning = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r packages}
library(tidyverse)
source("sim_functions.R")
```

## Goals

This notebook serves to describe and implement a simulation to test the procedures currently used to measure soil organic carbon (SOC) against a known groundtruth. Questions to be answered include:

- With what accuracy can we recover true SOC on average (mean squared error)?
- Are estimates of SOC likely to center on the truth (bias)?
- Are estimates of uncertainty (standard errors) reflecting the true degree of uncertainty in the estimates (coverage of confidence intervals / type 1 error rate)? 


## Empirical Input: The Marin Data

Simulations will be based off of samples from Marin County collected by the Silver Lab at UC Berkeley.

```{r duplicate data, message = FALSE}
duplicate_data <- read_csv("mcp_duplicates.csv")
#drop samples that were rerun fewer or more than 2 times
no_dups <- names(which(table(duplicate_data$sample_name) < 2))
#also drop runs of atropine standards
duplicate_data <- duplicate_data %>%
  filter(!(sample_name %in% no_dups)) %>%
  filter(!(substr(sample_name, 1, 4) %in% c('atro','blan','Blan','dumm','Dumm'))) %>%
  group_by(sample_name) %>%
  filter(rank(time) <= 2)

duplicate_data
```

```{r pct carbon}
pct_carbon <- duplicate_data$carbon / 100
hist(pct_carbon, breaks = 30, xlab = "Proportion SOC")
```


### Bulk Density 

In addition to % SOC, bulk density measurements are needed to compute the total amount of SOC in a plot of land. For the time being we treat bulk density as known and fixed across a plot. Ryals et al (2014) report bulk density ranging from .87 to 1.27 g/cm$^3$, based on cores taken from teh walls of a pit, with one pit per plot. We will use 1 g/cm$^3$ as the bulk density in our simulations to compute total SOC.

## Simulating Percent SOC

As a first step, we simulate a "ground truth" (so to speak), which is a 3-dimensional grid on a rectangular prism that represents SOC concentration (in percent) over the plot of land to be studied. The dimensions are `latitude`, `longitude`, and `depth` (in that order). The scale is in meters. 

However, simulating a field of % SOC is not entirely straightforward. In particular we would like to generate numbers that:

- Are bounded between 0 and 1 (0% and 100% SOC).
- Allow for arbitrary correlation between points.
- Have an adjustable mean and variance.





```{r simulated surface}
source("sim_functions.R")

test_sim <- simulate_truth(size = c(250,600), nugget = .01, sill = .05, range = 20, intercept = .01, y_trend = TRUE, max_mean = .2)

sim_plot <- ggplot(data = simulation, aes(x = x, y = y, fill = z)) + 
  geom_raster()
sim_plot
```


<!---
The total Carbon in a plot of land, in Megagrams Carbon per hectare (Mg C / ha), is computed from both the percent carbon and the bulk density (a measure of the density of the soil). The bulk density is itself difficult to sample and compute. For the time being we will treat this as fixed and known. From the Silver lab report for California's Fourth Climate Change Assessment, average bulk density across a number of Californian sites was about 1.2 grams per cubic centimeter (g / cm$^3$), which is the number I will use.

```{r total carbon, include = FALSE}
#note that our imaginary surface is at the 10 x 10 x 10 cm scale, which is 1000 cubic centimeters.
#this implies a bulk density of 1.2 * 1000 = 1200 grams per grid point. 
bulk_density <- 1200
carbon_mass_surface <- bulk_density * simulated_surface
#total carbon in megagrams
total_carbon <- sum(carbon_mass_surface) * (1e-6)
#a 60 x 25 meter plot is .15 of a hectare
MgC_per_ha <- total_carbon / .15
```

The Mg C / ha in our simulation is `r round(MgC_per_ha)`, which is not very far off from 53 Mg C / ha observed in the Sierra foothills, as observed in [Ryals et al 2014](https://www.sciencedirect.com/science/article/abs/pii/S003807171300312X). In the [CCA4 report](https://www.energy.ca.gov/sites/default/files/2019-07/Agriculture_CCCA4-CNRA-2018-002.pdf), the Silver lab reported stocks of 11 to 108 Mg C / ha across a range of sites in California, with a mean stock of 27 Mg C / ha.
!--->


# Sampling 

For our purposes, key features of Silver lab sampling are:

- Plots are 60 by 25 meters.
- Samples are taken along a transect with $n = 9$ samples per plot (sometimes $n=5$ samples per plot). It is not clear if these are randomized at all or merely start at one corner, however I believe the sampling falls under the category of systematic random sampling, i.e. the initial location is random (see figure from Allen et al below).
- Occasionally, plots are stratified and multiple transects will be taken (e.g. 3 transects with 3 samples each)
- Soils are collected using a 7 cm corer, at 4 depths: 0-10 cm, 10-30 cm, 30-50 cm, and 50-100 cm.



# Measurement

Once samples have been taken, error in the assay itself remains a concern. The Silver lab takes duplicate measurements until two runs are within 10% of each other (this often happens after the first two runs of any given sample). These percent differences are computed as:

$$\delta = 100 * \bigg | \frac{x_1 - x_2}{\frac{1}{2}(x_1 + x_2)} \bigg |$$

I add in measurement noise for each point by drawing a random sample from the observed percent differences between the Marin County duplicates, and then adding uniform noise at the scale of the sampled percent difference.

```{r measurement noise}
abs_diff <- function(x){
  abs(x[1] - x[2])
}
pct_diff <- function(x){
  2 * 100 * abs((x[1] - x[2]) / (x[1] + x[2]))
}
pct_differences <- duplicate_data %>%
  group_by(sample_name) %>%
  summarize(N_pct_diff = pct_diff(nitrogen), C_pct_diff = pct_diff(carbon), N_abs_diff = abs_diff(nitrogen), C_abs_diff = abs_diff(carbon), C_mean = mean(carbon), N_mean = mean(nitrogen), C_range = abs(diff(carbon)))
```



# Analysis 

According to [Ryals et al 2014](https://www.sciencedirect.com/science/article/abs/pii/S003807171300312X), the carbon stock in a plot is computed by averaging the samples and then multiplying by the bulk density measurement. These averages are then treated as fixed and analyzed with ANOVA for final inference about treatment effects. 


# Simulations 

We first generate 10 plots (5 treatment, 5 control) using the simulation set up above. All surfaces are generated in exactly the same way so that the true treatment effect is 0. Then we run 1000 simulations of the sampling, measurement, and analysis schemes as described above. 

```{r simulations}
surfaces <- lapply(1:10, simulate_truth)
treatment <- c(rep(1, 5), rep(0, 5))
#bulk density as the weight of the entire plot in grams
bulk_density <- 1200 * 600 * 250
#run simulations
simulation_results <- run_sims(n_sims = 1000, surfaces = surfaces, pct_perturbations = pct_differences$C_pct_diff, treatment = treatment, bulk_density = bulk_density)

avg_estimated_std_error <- mean(simulation_results[,3])
true_std_error <- sd(simulation_results[,2])
type_1_error_rate <- mean(simulation_results[,4] < .05)
hist(simulation_results[,2] / 1e6, xlab = "SOC ATE (Mg C / ha)", main = "Estimated ATE Distribution", breaks = 30)
```

