---
title: "Simulating SOC Measurement"
author: "Jake Spertus"
date: "October 31st, 2019"
output: html_notebook
---

```{r knitr setup, message = FALSE, warning = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r packages}
library(tidyverse)
```

## Goals

This notebook serves to describe and implement a simulation to test the procedures currently used to measure soil organic carbon (SOC) against a known groundtruth. Questions to be answered include:

- With what accuracy can we recover true SOC on average (mean squared error)?
- Are estimates of SOC likely to center on the truth (bias)?
- Are estimates of uncertainty (standard errors) reflecting the true degree of uncertainty in the estimates (coverage of confidence intervals / type 1 error rate)? 


## Empirical Input: The Marin Data

Simulations will be based off of samples from Marin County collected by the Silver Lab at UC Berkeley.

```{r duplicate data, message = FALSE}
duplicate_data <- read_csv("mcp_duplicates.csv")
#drop samples that were rerun fewer or more than 2 times
multiple_dups <- names(which(table(duplicate_data$sample_name) != 2))
#also drop runs of atropine standards
duplicate_data <- duplicate_data %>%
  filter(!(sample_name %in% multiple_dups)) %>%
  filter(substr(sample_name, 1, 4) != 'atro') 

duplicate_data
```

```{r pct carbon}
pct_carbon <- duplicate_data$carbon / 100
hist(pct_carbon, breaks = 30, xlab = "Proportion SOC")
```


## Simulating Percent SOC

As a first step, we simulate a "ground truth" (so to speak), which is a 3-dimensional grid on a rectangular prism that represents SOC concentration (in percent) over the plot of land to be studied. The dimensions are `latitude`, `longitude`, and `depth` (in that order). The scale is in meters. 

However, simulating a field of % SOC is not entirely straightforward. In particular we would like to generate numbers that:

- Are bounded between 0 and 1 (0% and 100% SOC).
- Allow for arbitrary correlation between points.
- Have an adjustable mean and variance.


I have explored using a Gaussian copula for this, but for now I will use a beta distribution where the mean is a function varying across space, and besides sharing a similar mean, there is no spatial correlation among close points. The [beta](https://en.wikipedia.org/wiki/Beta_distribution) is a distribution defined on [0,1], often used to model probabilities or proportions. For $X \sim \mbox{Beta}(\alpha, \beta)$ we have:

$$\mathbb{P}(X = x) =  \frac{x^{\alpha - 1} (1-x)^{\beta - 1}}{\mbox{B}(\alpha, \beta)} ~~\mbox{where}~~ \mbox{B}(\alpha,\beta) = \frac{\Gamma(\alpha)\Gamma(\beta)}{\Gamma(\alpha + \beta)}$$
$\Gamma$ is the Gamma function, a generalization of factorial. The beta has mean $\mathbb{E}(X) = \frac{\alpha}{\alpha + \beta}$ and variance $\mathbb{V}(X) = \frac{\alpha \beta}{(\alpha + \beta)^2 (\alpha + \beta + 1)}$

Given a particular mean $\mathbb{E}(X) = \mu$ and variance $\mathbb{V}(X) = \sigma^2$, we can write the parameters in terms of them:

\begin{align*}
\alpha &= \bigg (\frac{1 - \mu}{\sigma^2} - \frac{1}{\mu} \bigg ) \mu^2\\
\beta &= \alpha\bigg (\frac{1}{\mu} - 1 \bigg )
\end{align*}

Note that we must have $\mu \in (0,1)$ and $\sigma^2 < \mu (1 - \mu)$.

We can fit a beta distribution to the marginal distribution of carbon that we find in our duplicates:

```{r beta fit}
#little function to return beta parameters given a mean and variance
compute_beta_params <- function(mu, sigma_squared){
  alpha <- ((1 - mu) / sigma_squared - 1 / mu) * mu^2
  beta <- alpha * (1 / mu - 1)
  c("alpha" = alpha, "beta" = beta)
}

mean_carbon <- mean(pct_carbon)
var_carbon <- var(pct_carbon)
beta_params <- compute_beta_params(mu = mean_carbon, sigma_squared = var_carbon)
grid <- seq(0, max(pct_carbon), by=.001)

hist(pct_carbon, breaks = 30, xlab = "Proportion SOC", freq = FALSE)
points(y = dbeta(grid, shape1 = beta_params[1], shape2 = beta_params[2]), x = grid, type = 'l', col = 'blue', lwd = 2)
```



```{r simulate truth}

simulate_truth <- function(){
  #since silver lab plots are 60 x 25 meters, this gives a resolution of .1 meters
  n_latitude <- 600
  n_longitude <- 250
  #samples are collected at 4 depths: 0-10 cm, 10-30cm, 30-50cm, and 50-100cm
  n_depth <- 4
  d <- n_latitude * n_longitude
  
  #first simulate a surface that is a "slope" with the mean decreasing linearly as we move down the surface
  #mean varies across rows, it decreases linearly from .06 to .01
  grid <- (1:n_latitude) / n_latitude
  linear_mean <- .06 * (1-grid) + .01 * grid
  mean_matrix <- matrix(data = rep(linear_mean, n_latitude), nrow = n_latitude, ncol = n_longitude)
  #fix variance initially
  var_matrix <- matrix(.0003, nrow = n_latitude, ncol = n_longitude)
  #simulated carbon matrix
  carbon_matrix <- matrix(0, nrow = n_latitude, ncol = n_longitude)
  for(i in 1:n_latitude){
    for(j in 1:n_longitude){
      beta_params <- compute_beta_params(mu = mean_matrix[i,j], sigma_squared = var_matrix[i,j])
      carbon_matrix[i,j] <- rbeta(n = 1, shape1 = beta_params[1], shape2 = beta_params[2])
    }
  }
  carbon_matrix
}

simulated_surface <- simulate_truth()
```

We can see that the empirical mean over the rows follows the pattern we designated for the true mean. Interestingly the median gets very close to 0 when the mean gets small.


```{r plot simulated surface}
#marginal histogram
hist(simulated_surface, xlab = "Prop Carbon", freq = FALSE)
#means by row
plot(apply(simulated_surface, 1, mean), xlab = "Row", ylab = "Mean Prop Carbon")
#turn to a long dataframe to plot with ggplot
melted_simulated_surface <- reshape2::melt(simulated_surface)
matplot <- ggplot(melted_simulated_surface, aes(x=Var2, y=Var1, fill=value)) + 
  geom_tile() +
  ylab("Latitude (Rows)") +
  xlab("Longitude (Columns)") +
  scale_y_reverse() +
  scale_fill_gradient2(midpoint = 0.05)
matplot
```

# Sampling 

For our purposes, key features of Silver lab sampling are:

- Plots are 60 by 25 meters.
- Samples are taken along a transect with $n = 9$ samples per plot (sometimes $n=5$ samples per plot). It is not clear if these are randomized at all or merely start at one corner, however I believe the sampling falls under the category of systematic random sampling, i.e. the initial location is random (see figure from Allen et al below).
- Soils are collected using a 7 cm corer, at 4 depths: 0-10 cm, 10-30 cm, 30-50 cm, and 50-100 cm.

![*Soil sampling as described in Allen et al 2010 "A review of sampling designs for the measurement of soil organic carbon in Australian grazing lands."*](sampling_picture.png)

We focus on "design based" (random) sampling here. An alternative approach is "model based" sampling, where sample locations are chosen purposively based on prior knowledge in the form of a model (e.g. a variogram). 

Our notation follows Allen et al 2010. Let $\{y_1,...y_n\}$ be $n$ measurements of percent SOC taken within a plot and suppose, for the moment, they comprise a simple uniform random sample from the plot and are measured without error. Then in this simple case unbiased estimates of the mean $\mu_s$, variance \sigma_s^2, and variance of the mean \sigma_s^2(\hat{\mu}_s) are given by:

\begin{align*}
\hat{\mu}_s &= \frac{1}{n} \sum_{i=1}^n y_i\\
\hat{\sigma}_s^2 &= \frac{1}{(n-1)} \sum_{i=1}^n y_i\\
\hat{\sigma}_s^2(\hat{\mu}_s) &=  \frac{\hat{\sigma}_s^2}{n} 
\end{align*}

# Measurement



# Analysis 

